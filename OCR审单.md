# OCR审单技术方案

## 1. OCR审单总体架构图
    
![image](http://bw-media-service.oss-cn-beijing.aliyuncs.com/media/files/test/test/20190124/13/80378e82-c1f2-4b3b-a708-719f12c2cb67.png)
    
    
## 2. 业务流程

### 2.1 业务主流程
![image](http://bw-media-service.oss-cn-beijing.aliyuncs.com/media/files/test/test/20190124/11/a4972144-680d-4960-b914-55bdba11bfc7.png)

### 2.2 跨职能流程图
![image](http://bw-media-service.oss-cn-beijing.aliyuncs.com/media/files/test/test/20190124/11/962ad323-f4f8-46ce-b3d9-8f1e07d4f8a9.png)

### 2.3 主要流程图
![image](http://bw-media-service.oss-cn-beijing.aliyuncs.com/media/files/test/test/20190124/11/f376dcc6-b89a-49fa-8bef-34f76a78e461.png)

## 3. 数据库

### 3.1 主要关联表
TabName | 表中文名 | 描述
--- | --- | ---
biz_invoice | 票据表 | 存放票据主要信息
biz_invoice_detail | 票据详情表 | 存放票据中详细信息
biz_bill | 单据表 | 单据（报销单）主要信息，和票据的一对多映射
biz_file | 影像文件表 | 存放影像文件信息和票据的一对多映射
sys_biz_cost_note | 费用-票据关系表 | 存放费用类型、票据类型的关联数据
sys_biz_cost_note_goods | 费用-票据-商品简码表 | 存放费用类型、票据类型、商品简码的关联数据
sys_dict | 字典表 | 存放系统级公共配置及类型信息
biz_bill_invoice_check | 单据-审核发票表 | 存放单据审核状态信息
biz_invoice_position | 发票坐标表 | 存放影像中发票位置信息，影像中发票位置定位，并关联发票
sys_biz_use_type | 业务类型配置表 | 配置扩展业务类型
sys_biz_bill_config | 单据配置表 | 配置扩展单据类型
sys_biz_invoice_config | 发票配置表 | 配置扩展发票类型

### 3.2 主要表E-R图

![image](http://bw-media-service.oss-cn-beijing.aliyuncs.com/media/files/test/test/20190124/13/4ae54dfa-ceaa-4f64-b737-47dec54725fd.png)

## 4. 接口

### 4.1 app端

#### 1）首页展示
    1. 首页展示最新3张发票接口
    描述：在改用户的票夹中，按照票据插入时间倒序排列，查询最新插入的3条票据

#### 2）票夹
    1. 微信卡包批量入库接口
    描述：通过用户勾选微信发票列表，提交则插入发票到发票信息表。
        其中
        1）需通过票据号码推出票据种类. 
        2）根据校验开关入库前调用校验接口校验. 
        3）若校验则将校验结果插入发票详情信息表
    2. 票夹计算累计张数和金额接口
    描述：根据条件计算所有符合条件的票据张数和总金额。
        其中条件
        1）票据状态为未提交/审核中/已审核. 
        2）开票日期. 
        3）票据类型. 
        4）查验状态
    3. 票夹分页查询票据列表接口
    描述：根据条件筛选出所有符合条件的票据列表。
        其中条件
        1）票据状态为未提交/审核中/已审核. 
        2）票据列表按月份分组，组内按插入时间倒序
    4. 查询全票面信息接口
    描述：根据发票信息查询该发票的全票面详情。其中该发票已被查验
    5. 发票查验接口
    描述：根据发票4要素调用税局所提供的接口进行查验，并将查验结果保存至数据库，返回查验的结果或全票面信息
    6. 关联单据接口
    描述：保存用户选择的单据和单据信息。其中1）单据信息包含单据类型和单据号. 2）单据包含用户选择的票据列表

#### 3）票据采集
    1. 票据采集展示票据种类接口
    描述：查询所有票据种类，该票据种类为web端可配置项。
    2. 票据采集文件上传接口
    描述：票据采集时，上传用户选择的影像文件。
        其中采集类型包含
        1）手动采集. 
        2）拍照采集
    3. 手动采集新增接口
    描述：保存手动采集的票据信息。包含票据类型、四要素、其他输入信息
    4. 扫码采集新增接口
    描述：保存扫码采集的票据信息。包含票据类型、四要素、其他传入信息。
        其中票据类型需要按照规则反推
    5. 拍照采集获取影像坐标接口
    描述：拍照采集时，通过ocr识别用户所上传的影像中的票据并返回影像中票据信息及其坐标。
    6. 拍照采集识别接口
    描述：用户拍照采集时，选择影像文件后，步骤：
        1）保存文件到服务器. 
        2）调用ocr识别影像. 
        3）根据是否查验标识查验票据信息. 
        4）返回所识别的影像信息集合. 
        其中2）根据是否增值税发票标识判断先调用合合，再调睿奇

#### 4）单据
    1. 查询单据类型接口
    描述：查询所有单据类型，该单据类型为web端可配置项。
    2. 单据列表查询接口
    描述：根据条件分页查询当前用户下的单据列表。其中条件为：待审核/未通过/全部/审核通过。
    3. 单据详情查询接口
    描述：根据单据id查询该单据的详情信息。

#### 5）配置
    1. 获取查验开关接口
    描述：查询数据库该配置项标识。其中该标识为WEB端系统可配置项。
    
* 预计工作量：10人天

### 4.2 web端

#### 1）员工
    1. 单据列表查询接口-当前用户
    描述：根据输入条件分页查询当前用户下的单据列表。
        其中查询条件
        1）单据编号支持模糊查询. 
        2）单据类型. 
        3）处理环节. 
        4）创建时间.
    2. 查询单据信息接口
    描述：同app
    3. 票据列表查询接口
    描述：根据单据id查询该单据下的所有票据列表。
    4. 查询单据下的影像接口
    描述：根据单据id查询用户提交的所有影像及其影像所对应的票据信息，其中每个影像可能对应多个票据。
    5. 查询影像和票据接口
    描述：根据用户采集的影像id查询对应的影像文件及票据信息
    6. 查询票据和影像接口
    描述：根据票据id查询用户提交的票据信息及影像

#### 2）审单采集
    1. 单据列表查询接口-审单采集
    描述：单据列表中，分页查询单据列表信息，根据条件分页查询单据列表信息。
        其中条件
        1）选择机构 
        2）单据编号支持模糊查询 
        3）创建人 
        4）创建时间 
        5）单据类型 
        6）处理环节 
        7）审单结果
    2. 票据列表查询接口-审单采集
    描述：根据审单采集下的单据id查询票据列表。
    3. 查询单个票据接口
    描述：根据审单采集下的票据id查询票据信息及其所对应的影像文件。
    4. 查询未匹配影像接口
    描述：当票据下用户提交的影像未与审单采集的影像关联上时，根据票据id查询用户采集的未关联的影像集合。
    5. 影像匹配接口
    描述：当手动匹配影像时，绑定指定的(票据表中)票据与影像的关联关系。
    6. 编辑票据信息接口
    描述：根据票据id更新票据信息，通用接口，支持所有票据类型的修改。

#### 3）配置
    1. 查询单据类型接口
    描述：同app
    2. 字典表接口
    描述：根据字典项字段条件查询单个或所有字典项。
    3. 修改查验控制开关接口
    描述：修改数据库中记录app和web票据查验的配置标识
    4. 查询查验控制开关接口
    描述：修查询数据库中记录app和web票据查验的配置标识
    5. 查询业务类型接口
    描述：查询数据库配置项中所有的业务类型
    6. 单据类型添加接口
    描述：数据库中插入一条单据类型，该类型为数据库中的配置项
    7. 单据类型编辑接口
    描述：通过单据类型编号修改数据库中一条单据类型，该类型为数据库中的配置项
    8. 单据类型删除接口
    描述：通过单据类型编号删除数据库中一条单据类型，该类型为数据库中的配置项
    9. 单据类型分页查询接口
    描述：单据配置中，分页查询所有的单据类型列表。
    10. 业务类型添加接口
    描述：添加单据时配置项中，添加一条单据类型，其中包含处理规则的选择。
    11. 业务类型编辑接口
    描述：更新一条业务类型的配置
    12. 业务类型删除接口
    描述：删除一条业务类型，其中删除为逻辑删除
    13. 业务类型查询接口
    描述：查询所有业务类型项
    14. 根据业务类型id查询接口
    描述：通过id查询单个业务类型
    15. 图像压缩配置查询接口
    描述：查询客户端上传服务器时，影像图像上传的压缩比例，该项为配置项
    16. 图像压缩配置修改接口
    描述：修改客户端上传服务器时，影像图像上传的压缩比例，该项为配置项

* 预计工作量：16人天

### 4.3 客户端
    1. 获取批次号接口
    描述：根据规则生成批次号，供客户端扫描单据使用。
        其中批次号规则yyyyMMdd+6位流水号
    2. 提交影像接口
    描述：客户端扫描完单据后，以批次号为根节点，提交批次号下所有的影像文件，服务器进行和用户通过app提交的
        单据匹配，对于未匹配的返回票据id集合返回，匹配的入库。
    3. OCR识别接口
    描述：根据标识判断调用外部ocr识别接口进行影像识别，入库，并返回识别结果。其中标识包含是否未增值税发票
        调用合合，调用失败或非增值税发票则调用睿奇ocr识别接口。
    4. 发票查验接口
    描述：同app
    5. 进项权限接口
    描述：查询配置项中的进项权限标识
    6. 查询影像类型接口
    描述：查询字典表中影像类型、发票类型，并返回查询结果
    7. 查询票据类型接口
    描述：查询字典表返回票据类型

* 预计工作量：4人天

## 5. 总体工时

阶段 | 时间
---|---
数据库设计 | 4天
接口文档 | 3天
后端接口开发 | 30人天
前端开发 | 
UI设计 | 
前后端联调 | 
提测 | 
上线 | 


